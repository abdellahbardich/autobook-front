<div class="conversation-container" *ngIf="conversation">
  <div class="conversation-header">
    <h2>{{ conversation.title }}</h2>
    <div class="actions">
      <button class="btn btn-primary" (click)="toggleBookForm()">
        {{ showBookForm ? "Cancel" : "Create Book" }}
      </button>
    </div>
  </div>

  <div class="content-area">
    <div class="chat-area">
      <div class="messages-container">
        <div
          class="message"
          *ngFor="let message of conversation.messages"
          [ngClass]="{
            'user-message': message.sender === 'USER',
            'system-message': message.sender === 'SYSTEM'
          }"
        >
          <div class="message-content">{{ message.content }}</div>
          <div class="message-timestamp">
            {{ message.createdAt | date : "short" }}
          </div>
        </div>
      </div>

      <div class="input-container">
        <form [formGroup]="messageForm" (ngSubmit)="sendMessage()">
          <textarea
            formControlName="content"
            placeholder="Type your message..."
            [disabled]="loading"
            class="form-control"
          ></textarea>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="messageForm.invalid || loading"
          >
            <i class="fa fa-paper-plane"></i> Send
          </button>
        </form>
      </div>
    </div>

    <div class="sidebar">
      <div class="book-form-container" *ngIf="showBookForm">
        <h3>Create a New Book</h3>
        <form [formGroup]="bookForm" (ngSubmit)="createBook()">
          <div class="form-group">
            <label for="title">Title</label>
            <input
              type="text"
              id="title"
              formControlName="title"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label for="prompt">Prompt</label>
            <textarea
              id="prompt"
              formControlName="prompt"
              class="form-control"
              rows="3"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="bookType">Book Type</label>
            <select
              id="bookType"
              formControlName="bookType"
              class="form-control"
            >
              <option [value]="BookType.TEXT_ONLY">Text Only</option>
              <option [value]="BookType.IMAGE_ONLY">Image Only</option>
              <option [value]="BookType.TEXT_IMAGE">Text and Images</option>
            </select>
          </div>

          <div class="form-group">
            <label for="stylePrompt">Style Prompt</label>
            <input
              type="text"
              id="stylePrompt"
              formControlName="stylePrompt"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label for="numChapters">Number of Chapters</label>
            <input
              type="number"
              id="numChapters"
              formControlName="numChapters"
              class="form-control"
              min="1"
              max="10"
            />
          </div>

          <div class="form-check">
            <input
              type="checkbox"
              id="includeIllustrations"
              formControlName="includeIllustrations"
              class="form-check-input"
            />
            <label for="includeIllustrations" class="form-check-label"
              >Include Illustrations</label
            >
          </div>

          <button
            type="submit"
            class="btn btn-primary w-100 mt-3"
            [disabled]="bookForm.invalid || loading"
          >
            <span
              *ngIf="loading"
              class="spinner-border spinner-border-sm me-2"
              role="status"
              aria-hidden="true"
            ></span>
            Create Book
          </button>
        </form>
      </div>

      <div class="books-container" *ngIf="books.length > 0">
        <h3>Books in this Conversation</h3>
        <div class="books-list">
          <div class="book-card" *ngFor="let book of books">
            <div class="book-cover">
              <!-- <img *ngIf="book?.bookId" [src]="getBookCoverUrl(book.bookId)" alt="{{ book?.title || 'Book' }} cover" 
     onerror="this.src='assets/images/placeholder-cover.jpg'"> -->
              <app-secure-image
                [url]="getBookCoverUrl(book.bookId)"
                [alt]="book.title + ' cover'"
                [placeholderUrl]="'assets/images/placeholder-cover.jpg'"
              ></app-secure-image>
              <div
                class="book-status"
                [ngClass]="{
                  'bg-failed': book.status?.toLowerCase() === 'failed',
                  'bg-processing': book.status?.toLowerCase() === 'processing',
                  'bg-complete': book.status?.toLowerCase() === 'complete'
                }"
              >
                {{ book.status }}
              </div>
            </div>
            <div class="book-info">
              <h4>{{ book.title }}</h4>
              <!-- <p class="book-type">{{ book.bookType.replace('_', ' ') }}</p> -->
              <!-- <span class="value">{{ book?.bookType?.replace('_', ' ') || 'Unknown' }}</span> -->
              <!-- <span class="value">{{ book.status }}qsdqsdqdqsq</span> -->
              <div class="book-actions">
                <button
                  class="btn btn-sm btn-outline-primary"
                  (click)="viewBookDetails(book.bookId)"
                  [disabled]="book.status !== BookStatus.COMPLETE"
                >
                  View
                </button>
                <button
                  class="btn btn-sm btn-primary"
                  (click)="downloadBook(book.bookId)"
                  [disabled]="book.status !== BookStatus.COMPLETE"
                >
                  <i class="fa fa-download"></i> Download
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="alert alert-danger" *ngIf="error">{{ error }}</div>

<div class="loading-overlay" *ngIf="loading">
  <div class="spinner-border text-light" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
